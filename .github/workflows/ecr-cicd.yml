# =============================================================================
# ì‡¼íŠ¹í—ˆ(Short-Cut) â€“ ECR ë¹Œë“œ/í‘¸ì‹œ CI/CD íŒŒì´í”„ë¼ì¸
# =============================================================================
# íŠ¸ë¦¬ê±°:
#   - develop ë¸Œëžœì¹˜ push â†’ short-cut-api-prod ECRì— ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ
#                           + ECS_SERVICE_PROD Secretì´ ì„¤ì •ëœ ê²½ìš° ECS ì„œë¹„ìŠ¤ ìžë™ ì—…ë°ì´íŠ¸
#   - v* íƒœê·¸ push       â†’ developê³¼ ë™ì¼í•œ production ë°°í¬ (ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ ì¶”ê°€)
#
# ì¸ì¦ ë°©ì‹: OIDC (AWS Access Key ì—†ì´ ìž„ì‹œ í¬ë ˆë´ì…œ ì‚¬ìš©)
# ìºì‹œ ì „ëžµ: GitHub Cache API (type=gha) ê¸°ë°˜ ë ˆì´ì–´ ìºì‹±
# =============================================================================

name: ECR ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ

on:
  push:
    branches:
      - develop   # production í™˜ê²½ ë°°í¬ (main ëŒ€ìš©)
    tags:
      - "v*"      # ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ (ì˜ˆ: v1.0.0) â†’ production ë°°í¬

# GitHub Actions OIDC í† í° ë°œê¸‰ì— í•„ìš”í•œ ê¶Œí•œ
permissions:
  id-token: write   # OIDC JWT í† í° ë°œê¸‰
  contents: read    # ì½”ë“œ ì²´í¬ì•„ì›ƒ

env:
  # AWS ì„¤ì • (GitHub Secretsì—ì„œ ì£¼ìž…)
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: develop ë¸Œëžœì¹˜ â†’ staging ECR ë¹Œë“œ/í‘¸ì‹œ
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-push-staging:
    # ì´ JOBì€ ë¹„í™œì„±í™”í•˜ê±°ë‚˜ stagingì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    # í˜„ìž¬ëŠ” developì´ ë°°í¬ìš©ì´ë¯€ë¡œ production JOBì—ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    if: false && github.ref == 'refs/heads/develop' && github.event_name == 'push'

    outputs:
      image-tag: ${{ steps.info.outputs.sha-tag }}

    steps:
      # â”€â”€ 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # â”€â”€ 2. OIDC ê¸°ë°˜ AWS ì¸ì¦ (í‚¤ ì—†ìŒ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: AWS ì¸ì¦ (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-oidc-role
          aws-region: ${{ secrets.AWS_REGION }}
          # ìµœëŒ€ ì„¸ì…˜ ì‹œê°„: 1ì‹œê°„ (ëŒ€í˜• ë¹Œë“œ ëŒ€ë¹„)
          role-session-name: GitHubActions-Staging-${{ github.run_id }}

      # â”€â”€ 3. ECR ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Amazon ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # â”€â”€ 4. Docker Buildx ì„¤ì • (ë ˆì´ì–´ ìºì‹œ ì§€ì›) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      # â”€â”€ 5. ê¸°ë³¸ ì •ë³´ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì •ë³´ ì„¤ì •
        id: info
        run: |
          SHA_TAG=$(echo "${{ github.sha }}" | cut -c1-7)
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          ECR_REPO="${{ secrets.ECR_REPO_STAGING }}"
          echo "sha-tag=${SHA_TAG}" >> $GITHUB_OUTPUT
          echo "image-uri=${ECR_REGISTRY}/${ECR_REPO}" >> $GITHUB_OUTPUT

      # â”€â”€ 6. Docker Meta ì¶”ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.info.outputs.image-uri }}
          tags: |
            type=sha,format=short,prefix=
            type=raw,value=staging-latest
            type=ref,event=branch

      # â”€â”€ 7. ë¹Œë“œ ë° í‘¸ì‹œ (ë ˆì´ì–´ ìºì‹œ ìµœì í™” ì ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ (Staging)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # GitHub Cache API ë ˆì´ì–´ ìºì‹± (scope ì§€ì •ìœ¼ë¡œ ë³‘ë ¬ ì¶©ëŒ ë°©ì§€)
          cache-from: type=gha,scope=${{ github.workflow }}-${{ github.ref_name }}
          cache-to: type=gha,mode=max,scope=${{ github.workflow }}-${{ github.ref_name }}
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
            GIT_BRANCH=${{ github.ref_name }}

      # â”€â”€ 8. ë¹Œë“œ ê²°ê³¼ ìš”ì•½ ì¶œë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ë¹Œë“œ ê²°ê³¼ ìš”ì•½
        run: |
          TAGS=$(echo "${{ steps.meta.outputs.tags }}" | tr '\n' ', ')
          echo "## ðŸ³ Staging ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ì»¤ë°‹ SHA | \`${{ steps.info.outputs.sha-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ë¯¸ì§€ íƒœê·¸ | \`${TAGS}\` |" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: main ë¸Œëžœì¹˜ / v* íƒœê·¸ â†’ production ECR ë¹Œë“œ/í‘¸ì‹œ + ECS ë°°í¬
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-push-production:
    name: "ðŸš€ Production ë¹Œë“œ/í‘¸ì‹œ (develop / v*)"
    runs-on: ubuntu-latest
    # develop ë¸Œëžœì¹˜ í‘¸ì‹œ ë˜ëŠ” v* íƒœê·¸ í‘¸ì‹œì¼ ë•Œë§Œ ì‹¤í–‰
    if: >
      (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
      (startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push')

    outputs:
      image-uri: ${{ steps.info.outputs.image-uri }}
      image-tag: ${{ steps.info.outputs.sha-tag }}
      ecs-deploy-enabled: ${{ steps.check-ecs.outputs.enabled }}

    steps:
      # â”€â”€ 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # â”€â”€ 2. OIDC ê¸°ë°˜ AWS ì¸ì¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: AWS ì¸ì¦ (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-oidc-role
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-Prod-${{ github.run_id }}

      # â”€â”€ 3. ECR ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Amazon ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # â”€â”€ 4. Docker Buildx ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      # â”€â”€ 5. ê¸°ë³¸ ì •ë³´ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì •ë³´ ì„¤ì •
        id: info
        run: |
          SHA_TAG=$(echo "${{ github.sha }}" | cut -c1-7)
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          ECR_REPO="${{ secrets.ECR_REPO_PROD }}"
          echo "sha-tag=${SHA_TAG}" >> $GITHUB_OUTPUT
          echo "image-uri=${ECR_REGISTRY}/${ECR_REPO}" >> $GITHUB_OUTPUT

      # â”€â”€ 6. Docker Meta ì¶”ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.info.outputs.image-uri }}
          tags: |
            type=sha,format=short,prefix=
            type=raw,value=latest
            type=ref,event=branch
            type=semver,pattern={{version}}

      # â”€â”€ 7. ë¹Œë“œ ë° ECR í‘¸ì‹œ (ë ˆì´ì–´ ìºì‹œ ìµœì í™” ì ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ (Production)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ github.workflow }}-${{ github.ref_name }}
          cache-to: type=gha,mode=max,scope=${{ github.workflow }}-${{ github.ref_name }}
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
            GIT_BRANCH=${{ github.ref_name }}

      # â”€â”€ 8. ë¹Œë“œ ê²°ê³¼ ìš”ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ë¹Œë“œ ê²°ê³¼ ìš”ì•½
        run: |
          TAGS=$(echo "${{ steps.meta.outputs.tags }}" | tr '\n' ', ')
          echo "## ðŸ³ Production ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ì»¤ë°‹ SHA | \`${{ steps.info.outputs.sha-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ë¯¸ì§€ íƒœê·¸ | \`${TAGS}\` |" >> $GITHUB_STEP_SUMMARY

      # â”€â”€ 8. ECS ë°°í¬ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (Secret ì¡´ìž¬ ê²€ì‚¬) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ECS ë°°í¬ ì„¤ì • í™•ì¸
        id: check-ecs
        run: |
          # job-level ifì—ì„œ secretsë¥¼ ì°¸ì¡°í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ stepì—ì„œ í™•ì¸ í›„ outputìœ¼ë¡œ ì „ë‹¬
          if [ -n "${{ secrets.ECS_SERVICE_PROD }}" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "[CI] ECS ë°°í¬ í™œì„±í™”: ECS_SERVICE_PROD ì„¤ì •ë¨"
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "[CI] ECS ë°°í¬ ë¹„í™œì„±í™”: ECS_SERVICE_PROD ë¯¸ì„¤ì •"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ (Production ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ í›„)
  # ECS_SERVICE_PROD Secretì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-ecs-production:
    name: "ðŸ—ï¸ ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ (Production)"
    runs-on: ubuntu-latest
    # production ë¹Œë“œê°€ ì„±ê³µí•œ í›„ì—ë§Œ ì‹¤í–‰
    needs: build-and-push-production
    # ECS_SERVICE_PROD Secretì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰ (ì²« ì´ë¯¸ì§€ í‘¸ì‹œ ì´í›„ í™œì„±í™”)
    # Note: secrets ì»¨í…ìŠ¤íŠ¸ëŠ” job-level ifì—ì„œ ì‚¬ìš© ë¶ˆê°€ â†’ outputìœ¼ë¡œ ìš°íšŒ
    if: >
      needs.build-and-push-production.result == 'success' &&
      needs.build-and-push-production.outputs.ecs-deploy-enabled == 'true'

    steps:
      # â”€â”€ 1. AWS ì¸ì¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: AWS ì¸ì¦ (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-oidc-role
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-ECS-Deploy-${{ github.run_id }}

      # â”€â”€ 2. ECR ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Amazon ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # â”€â”€ 3. ECS Task Definition ìƒˆ ë¦¬ë¹„ì „ ë“±ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (task-definition íŒŒì¼ í•„ìš”)
        uses: actions/checkout@v4

      - name: ECS Task Definition ì´ë¯¸ì§€ URI ì—…ë°ì´íŠ¸
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          # infra/ecs/task-definition-template.jsonì„ ê¸°ë°˜ìœ¼ë¡œ ì´ë¯¸ì§€ë§Œ êµì²´
          task-definition: infra/ecs/task-definition-template.json
          container-name: short-cut-api
          image: ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPO_PROD }}:${{ needs.build-and-push-production.outputs.image-tag }}

      # â”€â”€ 4. ECS ì„œë¹„ìŠ¤ ë°°í¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ECS ì„œë¹„ìŠ¤ì— ìƒˆ Task Definition ë°°í¬
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ secrets.ECS_SERVICE_PROD }}
          cluster: ${{ secrets.ECS_CLUSTER_PROD }}
          # ìƒˆ íƒœìŠ¤í¬ê°€ ì™„ì „ížˆ ì•ˆì •ì ì´ ë  ë•Œê¹Œì§€ ëŒ€ê¸° (íƒ€ìž„ì•„ì›ƒ: 10ë¶„)
          wait-for-service-stability: true

      # â”€â”€ 5. ë°°í¬ ê²°ê³¼ ìš”ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ðŸš€ ECS Production ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| í´ëŸ¬ìŠ¤í„° | \`${{ secrets.ECS_CLUSTER_PROD }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ì„œë¹„ìŠ¤ | \`${{ secrets.ECS_SERVICE_PROD }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ë°°í¬ ì´ë¯¸ì§€ | \`${{ needs.build-and-push-production.outputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
