# =============================================================================
# ì‡¼íŠ¹í—ˆ(Short-Cut) â€“ ECR ë¹Œë“œ/í‘¸ì‹œ CI/CD íŒŒì´í”„ë¼ì¸
# =============================================================================
# íŠ¸ë¦¬ê±°:
#   - develop ë¸Œëžœì¹˜ push â†’ short-cut-api-staging ECRì— ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ
#   - main ë¸Œëžœì¹˜ push   â†’ short-cut-api-prod ECRì— ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ
#                           + ECS_SERVICE_PROD Secretì´ ì„¤ì •ëœ ê²½ìš° ECS ì„œë¹„ìŠ¤ ìžë™ ì—…ë°ì´íŠ¸
#   - v* íƒœê·¸ push       â†’ mainê³¼ ë™ì¼í•œ production ë°°í¬ (ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ ì¶”ê°€)
#
# ì¸ì¦ ë°©ì‹: OIDC (AWS Access Key ì—†ì´ ìž„ì‹œ í¬ë ˆë´ì…œ ì‚¬ìš©)
# ìºì‹œ ì „ëžµ: GitHub Cache API (type=gha) ê¸°ë°˜ ë ˆì´ì–´ ìºì‹±
# =============================================================================

name: ECR ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ

on:
  push:
    branches:
      - develop   # staging í™˜ê²½ ë°°í¬
      - main      # production í™˜ê²½ ë°°í¬
    tags:
      - "v*"      # ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ (ì˜ˆ: v1.0.0) â†’ production ë°°í¬

# GitHub Actions OIDC í† í° ë°œê¸‰ì— í•„ìš”í•œ ê¶Œí•œ
permissions:
  id-token: write   # OIDC JWT í† í° ë°œê¸‰
  contents: read    # ì½”ë“œ ì²´í¬ì•„ì›ƒ

env:
  # AWS ì„¤ì • (GitHub Secretsì—ì„œ ì£¼ìž…)
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: develop ë¸Œëžœì¹˜ â†’ staging ECR ë¹Œë“œ/í‘¸ì‹œ
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-push-staging:
    name: "ðŸš€ Staging ë¹Œë“œ/í‘¸ì‹œ (develop)"
    runs-on: ubuntu-latest
    # develop ë¸Œëžœì¹˜ pushì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    outputs:
      image-tag: ${{ steps.meta.outputs.sha-tag }}

    steps:
      # â”€â”€ 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # â”€â”€ 2. OIDC ê¸°ë°˜ AWS ì¸ì¦ (í‚¤ ì—†ìŒ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: AWS ì¸ì¦ (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-oidc-role
          aws-region: ${{ secrets.AWS_REGION }}
          # ìµœëŒ€ ì„¸ì…˜ ì‹œê°„: 1ì‹œê°„ (ëŒ€í˜• ë¹Œë“œ ëŒ€ë¹„)
          role-session-name: GitHubActions-Staging-${{ github.run_id }}

      # â”€â”€ 3. ECR ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Amazon ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # â”€â”€ 4. Docker Buildx ì„¤ì • (ë ˆì´ì–´ ìºì‹œ ì§€ì›) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      # â”€â”€ 5. ì´ë¯¸ì§€ íƒœê·¸ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ì´ë¯¸ì§€ íƒœê·¸ ë©”íƒ€ë°ì´í„° ìƒì„±
        id: meta
        run: |
          # ì»¤ë°‹ SHA 7ìžë¦¬ ë‹¨ì¶• íƒœê·¸
          SHA_TAG=$(echo "${{ github.sha }}" | cut -c1-7)
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          ECR_REPO="${{ secrets.ECR_REPO_STAGING }}"

          echo "sha-tag=${SHA_TAG}" >> $GITHUB_OUTPUT
          echo "image-uri=${ECR_REGISTRY}/${ECR_REPO}" >> $GITHUB_OUTPUT
          echo "[CI] Staging ì´ë¯¸ì§€ URI: ${ECR_REGISTRY}/${ECR_REPO}:${SHA_TAG}"

      # â”€â”€ 6. ë¹Œë“œ ë° í‘¸ì‹œ (ë ˆì´ì–´ ìºì‹œ ì ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ (Staging)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          # ì´ë¯¸ì§€ íƒœê·¸: ì»¤ë°‹ SHA + staging-latest ë¡¤ë§ íƒœê·¸
          tags: |
            ${{ steps.meta.outputs.image-uri }}:${{ steps.meta.outputs.sha-tag }}
            ${{ steps.meta.outputs.image-uri }}:staging-latest
          # GitHub Cache API ë ˆì´ì–´ ìºì‹± (ë ˆì´ì–´ ë³€ê²½ ì—†ìœ¼ë©´ ìž¬ë¹Œë“œ ìŠ¤í‚µ)
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # ë¹Œë“œ ì¸ìˆ˜: ë¹Œë“œ ì‹œì  ì •ë³´ ì´ë¯¸ì§€ì— í¬í•¨
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
            GIT_BRANCH=${{ github.ref_name }}

      # â”€â”€ 7. ë¹Œë“œ ê²°ê³¼ ìš”ì•½ ì¶œë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ë¹Œë“œ ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ðŸ³ Staging ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ì»¤ë°‹ SHA | \`${{ steps.meta.outputs.sha-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ECR URI | \`${{ steps.meta.outputs.image-uri }}:${{ steps.meta.outputs.sha-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¡¤ë§ íƒœê·¸ | \`staging-latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¸Œëžœì¹˜ | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: main ë¸Œëžœì¹˜ / v* íƒœê·¸ â†’ production ECR ë¹Œë“œ/í‘¸ì‹œ + ECS ë°°í¬
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-push-production:
    name: "ðŸš€ Production ë¹Œë“œ/í‘¸ì‹œ (main / v*)"
    runs-on: ubuntu-latest
    # main ë¸Œëžœì¹˜ í‘¸ì‹œ ë˜ëŠ” v* íƒœê·¸ í‘¸ì‹œì¼ ë•Œë§Œ ì‹¤í–‰
    if: >
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push')

    outputs:
      image-uri: ${{ steps.meta.outputs.image-uri }}
      image-tag: ${{ steps.meta.outputs.sha-tag }}
      ecs-deploy-enabled: ${{ steps.check-ecs.outputs.enabled }}

    steps:
      # â”€â”€ 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # â”€â”€ 2. OIDC ê¸°ë°˜ AWS ì¸ì¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: AWS ì¸ì¦ (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-oidc-role
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-Prod-${{ github.run_id }}

      # â”€â”€ 3. ECR ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Amazon ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # â”€â”€ 4. Docker Buildx ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      # â”€â”€ 5. ì´ë¯¸ì§€ íƒœê·¸ ê³„ì‚° (ì»¤ë°‹ SHA + ì‹œë§¨í‹± ë²„ì „ ë³‘í–‰) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ì´ë¯¸ì§€ íƒœê·¸ ë©”íƒ€ë°ì´í„° ìƒì„±
        id: meta
        run: |
          SHA_TAG=$(echo "${{ github.sha }}" | cut -c1-7)
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          ECR_REPO="${{ secrets.ECR_REPO_PROD }}"

          echo "sha-tag=${SHA_TAG}" >> $GITHUB_OUTPUT
          echo "image-uri=${ECR_REGISTRY}/${ECR_REPO}" >> $GITHUB_OUTPUT

          # v* íƒœê·¸ í‘¸ì‹œì¸ ê²½ìš° ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ ì¶”ê°€
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            SEMVER_TAG="${{ github.ref_name }}"
            echo "semver-tag=${SEMVER_TAG}" >> $GITHUB_OUTPUT
            echo "[CI] ì‹œë§¨í‹± ë²„ì „ íƒœê·¸: ${SEMVER_TAG}"
          fi

          echo "[CI] Production ì´ë¯¸ì§€ URI: ${ECR_REGISTRY}/${ECR_REPO}:${SHA_TAG}"

      # â”€â”€ 6. ë¹Œë“œ ë° ECR í‘¸ì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ (Production)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          # ì»¤ë°‹ SHA + latest (+ ì‹œë§¨í‹± ë²„ì „ì´ ìžˆìœ¼ë©´ ì¶”ê°€)
          tags: |
            ${{ steps.meta.outputs.image-uri }}:${{ steps.meta.outputs.sha-tag }}
            ${{ steps.meta.outputs.image-uri }}:latest
            ${{ steps.meta.outputs.semver-tag && format('{0}:{1}', steps.meta.outputs.image-uri, steps.meta.outputs.semver-tag) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
            GIT_BRANCH=${{ github.ref_name }}

      # â”€â”€ 7. ë¹Œë“œ ê²°ê³¼ ìš”ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ë¹Œë“œ ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ðŸ³ Production ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ì»¤ë°‹ SHA | \`${{ steps.meta.outputs.sha-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ECR URI | \`${{ steps.meta.outputs.image-uri }}:${{ steps.meta.outputs.sha-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¡¤ë§ íƒœê·¸ | \`latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ì‹œë§¨í‹± ë²„ì „ | \`${{ steps.meta.outputs.semver-tag || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY

      # â”€â”€ 8. ECS ë°°í¬ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (Secret ì¡´ìž¬ ê²€ì‚¬) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ECS ë°°í¬ ì„¤ì • í™•ì¸
        id: check-ecs
        run: |
          # job-level ifì—ì„œ secretsë¥¼ ì°¸ì¡°í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ stepì—ì„œ í™•ì¸ í›„ outputìœ¼ë¡œ ì „ë‹¬
          if [ -n "${{ secrets.ECS_SERVICE_PROD }}" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "[CI] ECS ë°°í¬ í™œì„±í™”: ECS_SERVICE_PROD ì„¤ì •ë¨"
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "[CI] ECS ë°°í¬ ë¹„í™œì„±í™”: ECS_SERVICE_PROD ë¯¸ì„¤ì •"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ (Production ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ í›„)
  # ECS_SERVICE_PROD Secretì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-ecs-production:
    name: "ðŸ—ï¸ ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ (Production)"
    runs-on: ubuntu-latest
    # production ë¹Œë“œê°€ ì„±ê³µí•œ í›„ì—ë§Œ ì‹¤í–‰
    needs: build-and-push-production
    # ECS_SERVICE_PROD Secretì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰ (ì²« ì´ë¯¸ì§€ í‘¸ì‹œ ì´í›„ í™œì„±í™”)
    # Note: secrets ì»¨í…ìŠ¤íŠ¸ëŠ” job-level ifì—ì„œ ì‚¬ìš© ë¶ˆê°€ â†’ outputìœ¼ë¡œ ìš°íšŒ
    if: >
      needs.build-and-push-production.result == 'success' &&
      needs.build-and-push-production.outputs.ecs-deploy-enabled == 'true'

    steps:
      # â”€â”€ 1. AWS ì¸ì¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: AWS ì¸ì¦ (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-oidc-role
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-ECS-Deploy-${{ github.run_id }}

      # â”€â”€ 2. ECR ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Amazon ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # â”€â”€ 3. ECS Task Definition ìƒˆ ë¦¬ë¹„ì „ ë“±ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (task-definition íŒŒì¼ í•„ìš”)
        uses: actions/checkout@v4

      - name: ECS Task Definition ì´ë¯¸ì§€ URI ì—…ë°ì´íŠ¸
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          # infra/ecs/task-definition-template.jsonì„ ê¸°ë°˜ìœ¼ë¡œ ì´ë¯¸ì§€ë§Œ êµì²´
          task-definition: infra/ecs/task-definition-template.json
          container-name: short-cut-api
          image: ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPO_PROD }}:${{ needs.build-and-push-production.outputs.image-tag }}

      # â”€â”€ 4. ECS ì„œë¹„ìŠ¤ ë°°í¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ECS ì„œë¹„ìŠ¤ì— ìƒˆ Task Definition ë°°í¬
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ secrets.ECS_SERVICE_PROD }}
          cluster: ${{ secrets.ECS_CLUSTER_PROD }}
          # ìƒˆ íƒœìŠ¤í¬ê°€ ì™„ì „ížˆ ì•ˆì •ì ì´ ë  ë•Œê¹Œì§€ ëŒ€ê¸° (íƒ€ìž„ì•„ì›ƒ: 10ë¶„)
          wait-for-service-stability: true

      # â”€â”€ 5. ë°°í¬ ê²°ê³¼ ìš”ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ðŸš€ ECS Production ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| í´ëŸ¬ìŠ¤í„° | \`${{ secrets.ECS_CLUSTER_PROD }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ì„œë¹„ìŠ¤ | \`${{ secrets.ECS_SERVICE_PROD }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ë°°í¬ ì´ë¯¸ì§€ | \`${{ needs.build-and-push-production.outputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
