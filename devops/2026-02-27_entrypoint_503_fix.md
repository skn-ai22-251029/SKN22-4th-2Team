# [2026-02-27] 프로덕션 503 에러 영구 해결 보고서 (엔트리포인트 충돌 픽스)

## 🛠️ 코드베이스 분석 결과: 진짜 `503`의 원인
프론트엔드 환경에서 지속적으로 경험한 **"API 오류: 503" 은 애플리케이션의 뼈대(엔트리포인트)가 구버전 파일(main.py)을 향해 뻗어 있었기 때문에 발생**했습니다.

1. **폴더 구조의 분열**: 최근 기술 백로그 "FastAPI 웹 서비스화: 메인 라우터(`src/api/main.py`)" 작업이 진행되면서, 기존 루트 경로에 있던 `main.py` 대신 `src/api/main.py`가 새롭게 생성되어 전체 로직(SecurityMiddleware, 시크릿 변수 로드, 라우터 통합)을 대체했습니다.
2. **도커 컨테이너 엔트리포인트 실수**: 코드는 새로운 구조로 완벽히 마이그레이션되었으나, 정작 배포를 위한 도커 컨테이너 진입점인 `entrypoint.sh` 안에는 **과거의 `exec uvicorn main:app` 명령어**가 그대로 유지되어 작동했습니다.
3. **503 반환 과정 (과거 코드의 한계)**:
   - 과거 `main.py` 안에는 AWS Secrets Manager를 초기화하는 함수(`bootstrap_secrets()`)가 존재하지 않습니다.
   - 따라서 배포 시 환경 변수(`OPENAI_API_KEY` 등)나 DB의 초기 연결 정보를 불러오지 못한 채 실행되었습니다.
   - Pinecone DB 클라이언트 오류 등으로 인해 `/analyze` API 호출이 즉각 503 "Database client is unavailable." 에러를 던질 수 밖에 없었습니다.
4. (사용자님의 로컬 테스트 `uvicorn src.api.main:app`는 새로운 앱을 정확히 찌르고 있었기 때문에, 오직 클라우드 환경에서만 계속 문제가 발생했던 것입니다!)

### 조치 내역 (배포 완료)
- `entrypoint.sh` 내부의 uvicorn 실행 명령어 `main:app` 을 **`src.api.main:app`** 으로 정확하게 교체했습니다.
- 이를 통해 신규 아키텍처(시크릿 부트스트랩, 보안 등)가 모두 통합된 서버가 정상적으로 런칭되며, DB 클라이언트가 로드되어 503 오류를 뱉지 않게 됩니다.

---

### 📋 PM 및 DevOps 전달용 백로그 (복사해서 각 에이전트에게 전달하세요)
- **Epic: 리팩토링 및 CI/CD 안정화 단계**
  - [x] Docker 컨테이너 엔트리포인트(`entrypoint.sh`)가 신규 FastAPI 라우터(`src.api.main:app`)를 지칭하도록 수정 완료
  - [x] (배포된 앱) `bootstrap_secrets` 구동으로 환경 변수가 로드되어 DB 연결 503 오류 영구 해결
  - [ ] GitHub Actions를 통해 현재 `develop` 브랜치의 수정 사항(해당 커밋)이 AWS ECS로 모두 정상 배포되는지 약 5분 정도 모니터링
  - [ ] ECS 컨테이너 완전 구동 후 프로덕션 인프라에서의 검색엔진(API) 최종 E2E(End-to-End) 테스트
